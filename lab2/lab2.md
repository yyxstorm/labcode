#操作系统Lab2实验报告

2012011289
计22
姚宇轩

##练习零：填写已有实验

我使用的是understand的diff/merge工具。具体操作流程为：菜单中选择Tools\Compare\Compare files/folders...进去之后，上面的选项栏选择lab1，下面的选择lab2。然后就可以看到两个工程有什么不一样了。当需要把lab1的内容merge进lab2时，只需要点击左侧的merge selection即可。

##练习一：实现first-fit连续物理内存分配算法

###我的设计实现过程
在初始化阶段，假设需要分配n个空闲页空间，那么将这n个空间分别设置其flag位（为valid）、空间大小（为0）和引用个数（为0），并把这些页加到空闲列表中。最后，将这个空闲块的首页的空间大小设为n，并将可用内存大小`nr_free`加上n。

在分配空间阶段，从`free_list`开始顺序找到第一个空间大小大于等于n的空闲块。如果找到了以后，把它提取出来，将它首页到n页分别设置为不可用，并从`free_list`中删掉。如果本来这个空闲块大小是大于n的，那还必须把剩下的部分变成一个新的空闲块，即将此时的首页的空间大小设为`origin-n`。再将可用内存大小`nr_free`减去，返回这个页。如果找不到合适的空闲块，那么就返回NULL。

在释放内存阶段，先找到地址为base的页在`free_list`中的位置。然后，将base及其后n个页都加入到`free_list`中，并还原它们的标志位。最后，寻找合并空闲块的可能。先向后搜索，如果后面还有块，那么当前块的空间便加上后面的块空间，并将后面的块置为0（0的话也一样）。再向前搜索，找到第一个空闲块首页，并将两者合并。

###是否还有改进空间
每次分配或者释放内存，都要对n个页面进行操作；而我们的n可能会比较大。因此，是否可以考虑创建几种不同页大小的“小块”，使得在分配和释放时可以不用创建那么多的标记；当然，这肯定会引入新的标记，因此，不知道这种做法是否会有效地改进效率。（但是麻烦是肯定的，这似乎就有点buddy_system的意思了）



##练习二：实现寻找虚拟地址对应的页表项
###我的设计实现过程
首先，找到PDE。通过PDX获得线性地址中代表PDE的索引号，然后从pgdir这个基址中寻找。

	pde_t *pdep = &pgdir[PDX(la)];

如果它不存在，那么得分配一个包含此项的二级页表。此时就该调用`alloc_page()`分配页表，并且设立页面关联，清除对应物理地址空间的数据，并将pde的permission设置为可访问。

最后，返回PTE值。找到对应二级页表后，用`PTX(la)`获得二级页表中的偏移。

###PDE和PTE中每个组成部分的含义和对ucore而言的潜在用途
PDE和PTE的前20位都是地址，后12位的定义在`mmu.h`中有出现：

    #define PTE_P           0x001                   // Present
    #define PTE_W           0x002                   // Writeable
    #define PTE_U           0x004                   // User
    #define PTE_PWT         0x008                   // Write-Through
    #define PTE_PCD         0x010                   // Cache-Disable
    #define PTE_A           0x020                   // Accessed
    #define PTE_D           0x040                   // Dirty
    #define PTE_PS          0x080                   // Page Size
    #define PTE_MBZ         0x180                   // Bits must be zero
    #define PTE_AVAIL       0xE00                   // Available for software use
                                                    // The PTE_AVAIL bits aren't used by the kernel or interpreted by the
                                                    // hardware, so user processes are allowed to set them arbitrarily.

所以，第一位为存在位，代表是否缺页。第二位是可写位，用来确定该内存的访问权限。第三位是用户位，可以用来判断用户态？第四位是写直达位，确认Cache的写回方式。第五位是Cache开启位，用以确认Cache机制是否开启。第六位是访问记录位，可能用以Cache替换算法。第七位是修改位，可能用以确定要不要写回外存。第8-9位是保留位，以图后进。第10-12位是可用位，供给软件实现使用。

###如果ucore执行过程中访问内存，出现了页访问异常，硬件要做哪些事情？
硬件需要保存当前指令的各种状态信息以便恢复。需要禁止中断。需要通过操作系统来实现对应的置换或读写操作。

##练习三：释放某虚地址所在的页并取消对应二级页表项的映射
###我的设计实现过程
首先检查这个pte是否有效，如果有效，那么查询到它对应的页。将它对应的页关联数减一。如果没有实际空间再关联到它，那么释放该页。最后将该pte设为空，并使对应TLB失效。



###数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？
有关系。数组的第n项左移12位便是对应页目录项和页表项的高20位。
###如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？
放弃页机制可以完成此事……但是这应该不是想要的答案。
